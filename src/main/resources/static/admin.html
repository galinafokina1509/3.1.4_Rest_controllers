<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Page</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5.3.8 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
          rel="stylesheet"
          crossorigin="anonymous">

    <style>
        body {
            background-color: #f8f9fa;
        }
        .content-wrapper {
            max-width: 1100px;
        }
        .input-highlight:focus {
            background-color: #fff9d6;
        }

        /* делаем окно delete поменьше */
        .delete-modal-dialog {
            max-width: 500px;
        }

        /* более заметный серый фон в readonly-полях delete */
        .form-control.bg-light.text-muted,
        .form-select.bg-light.text-muted {
            background-color: #e9ecef !important; /* поярче серый */
            color: #6c757d !important;
        }
    </style>
</head>
<body>

<!-- Верхний бар -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text">
            <span id="currentUserEmail"></span>
            &nbsp;with roles:
            <span id="currentUserRoles"></span>
        </span>

        <form action="/logout" method="post" class="ms-auto mb-0">
            <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row justify-content-start">
        <!-- Сайдбар -->
        <div class="col-12 col-md-2 mb-3 mb-md-0">
            <ul class="nav nav-pills flex-md-column">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin.html">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/user.html">User</a>
                </li>
            </ul>
        </div>

        <!-- Контент -->
        <div class="col-12 col-md-10 content-wrapper">
            <h1 class="mb-3">Admin panel</h1>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="users-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#users-panel"
                            type="button"
                            role="tab"
                            aria-controls="users-panel"
                            aria-selected="true">
                        Users table
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="new-user-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#new-user-panel"
                            type="button"
                            role="tab"
                            aria-controls="new-user-panel"
                            aria-selected="false">
                        New User
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3" id="adminTabsContent">

                <!-- TAB: Users table -->
                <div class="tab-pane fade show active" id="users-panel" role="tabpanel" aria-labelledby="users-tab">
                    <div class="card">
                        <div class="card-header fw-bold">
                            All users
                        </div>
                        <div class="card-body">
                            <table class="table table-striped mb-0">
                                <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">First Name</th>
                                    <th scope="col">Last Name</th>
                                    <th scope="col">Age</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Role</th>
                                    <th scope="col">Edit</th>
                                    <th scope="col">Delete</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                <!-- строки добавляются JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: New User -->
                <div class="tab-pane fade" id="new-user-panel" role="tabpanel" aria-labelledby="new-user-tab">
                    <div class="card">
                        <div class="card-header fw-bold">
                            Add new user
                        </div>
                        <div class="card-body d-flex justify-content-center">
                            <div class="col-12 col-md-4">

                                <form id="newUserForm">
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">First name</label>
                                        <input type="text"
                                               name="name"
                                               class="form-control input-highlight"
                                               required>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">Last name</label>
                                        <input type="text"
                                               name="surname"
                                               class="form-control input-highlight"
                                               required>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">Age</label>
                                        <input type="number"
                                               name="age"
                                               class="form-control"
                                               required>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">Email</label>
                                        <input type="email"
                                               name="email"
                                               class="form-control input-highlight"
                                               required>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">Password</label>
                                        <input type="password"
                                               name="password"
                                               class="form-control">
                                    </div>
                                    <div class="mb-3 text-center">
                                        <label class="form-label fw-bold text-center d-block">Role</label>
                                        <select id="newUserRolesSelect"
                                                class="form-select"
                                                name="roles"
                                                multiple size="2">
                                            <!-- роли подгружаются JS -->
                                        </select>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-success">
                                            Add new user
                                        </button>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /tab-content -->

        </div>
    </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">

                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">First name</label>
                        <input type="text" id="editUserName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">Last name</label>
                        <input type="text" id="editUserSurname" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">Age</label>
                        <input type="number" id="editUserAge" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">Email</label>
                        <input type="email" id="editUserEmail" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">Password</label>
                        <input type="password" id="editUserPassword" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-center d-block">Role</label>
                        <select id="editUserRolesSelect"
                                class="form-select"
                                multiple size="2">
                            <!-- роли подгружаются JS -->
                        </select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Edit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete modal (по макету) -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered delete-modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- скрытое поле для id -->
                <input type="hidden" id="deleteUserId">

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">ID</label>
                    <input type="text"
                           class="form-control bg-light text-muted"
                           id="deleteUserIdInput"
                           readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">First name</label>
                    <input type="text"
                           class="form-control bg-light text-muted"
                           id="deleteUserNameInput"
                           readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">Last name</label>
                    <input type="text"
                           class="form-control bg-light text-muted"
                           id="deleteUserSurnameInput"
                           readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">Age</label>
                    <input type="number"
                           class="form-control bg-light text-muted"
                           id="deleteUserAgeInput"
                           readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">Email</label>
                    <input type="email"
                           class="form-control bg-light text-muted"
                           id="deleteUserEmailInput"
                           readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-center d-block">Role</label>
                    <select class="form-select bg-light text-muted"
                            id="deleteUserRolesSelect"
                            multiple size="2"
                            disabled>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button>
                <button type="button" id="confirmDeleteUserBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script>
    // ------- Вспомогательные функции с ролями и текущим пользователем --------

    function normalizeRoleName(roleName) {
        return roleName.replace('ROLE_', '');
    }

    function rolesToString(roles) {
        if (!roles) return '';
        return roles
            .map(r => normalizeRoleName(r.name))
            .sort((a, b) => {
                if (a === 'ADMIN' && b !== 'ADMIN') return -1;
                if (b === 'ADMIN' && a !== 'ADMIN') return 1;
                return a.localeCompare(b);
            })
            .join(' ');
    }

    async function loadCurrentUserInfo() {
        try {
            const res = await fetch('/api/user/me');
            if (!res.ok) return;
            const user = await res.json();

            document.getElementById('currentUserEmail').textContent = user.email || '';
            document.getElementById('currentUserRoles').textContent = rolesToString(user.roles);
        } catch (e) {
            console.error('Ошибка при загрузке текущего пользователя:', e);
        }
    }

    // ------- Глобальные данные -------

    let allRoles = [];
    let editUserModalInstance = null;
    let deleteUserModalInstance = null;

    // ------- Загрузка ролей -------

    async function loadRoles() {
        try {
            const res = await fetch('/api/admin/roles');
            if (!res.ok) {
                console.error('Ошибка при загрузке ролей:', res.status);
                return;
            }
            allRoles = await res.json();

            const newUserSelect = document.getElementById('newUserRolesSelect');
            const editUserSelect = document.getElementById('editUserRolesSelect');

            [newUserSelect, editUserSelect].forEach(select => {
                if (!select) return;
                select.innerHTML = '';
                allRoles.forEach(role => {
                    const opt = document.createElement('option');
                    opt.value = role.id;
                    opt.textContent = role.name;
                    select.appendChild(opt);
                });
            });
        } catch (e) {
            console.error('Ошибка при загрузке ролей:', e);
        }
    }

    // ------- Загрузка пользователей и заполнение таблицы -------

    async function loadUsers() {
        try {
            const res = await fetch('/api/admin/users');
            if (!res.ok) {
                console.error('Ошибка при загрузке пользователей:', res.status);
                return;
            }
            const users = await res.json();
            renderUsersTable(users);
        } catch (e) {
            console.error('Ошибка при загрузке пользователей:', e);
        }
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const tr = document.createElement('tr');

            const rolesStr = rolesToString(user.roles);

            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.surname}</td>
                <td>${user.age}</td>
                <td>${user.email}</td>
                <td>${rolesStr}</td>
                <td>
                    <button class="btn btn-info btn-sm text-white">Edit</button>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm">Delete</button>
                </td>
            `;

            const editBtn = tr.querySelector('.btn-info');
            const deleteBtn = tr.querySelector('.btn-danger');

            editBtn.addEventListener('click', () => openEditModal(user));
            deleteBtn.addEventListener('click', () => openDeleteModal(user));

            tbody.appendChild(tr);
        });
    }

    // ------- Создание нового пользователя -------

    async function createUser(formData) {
        const selectedRoleIds = Array.from(
            document.getElementById('newUserRolesSelect').selectedOptions
        ).map(opt => Number(opt.value));

        const body = {
            name: formData.get('name'),
            surname: formData.get('surname'),
            age: Number(formData.get('age')),
            email: formData.get('email'),
            password: formData.get('password'),
            roles: selectedRoleIds.map(id => ({ id }))
        };

        const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            console.error('Ошибка при создании пользователя:', res.status);
        }
    }

    // ------- Редактирование пользователя -------

    function openEditModal(user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserSurname').value = user.surname;
        document.getElementById('editUserAge').value = user.age;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserPassword').value = '';

        const select = document.getElementById('editUserRolesSelect');
        const userRoleIds = (user.roles || []).map(r => r.id);

        Array.from(select.options).forEach(opt => {
            opt.selected = userRoleIds.includes(Number(opt.value));
        });

        if (!editUserModalInstance) {
            editUserModalInstance = new bootstrap.Modal(document.getElementById('editUserModal'));
        }
        editUserModalInstance.show();
    }

    async function updateUser() {
        const id = document.getElementById('editUserId').value;

        const selectedRoleIds = Array.from(
            document.getElementById('editUserRolesSelect').selectedOptions
        ).map(opt => Number(opt.value));

        const body = {
            name: document.getElementById('editUserName').value,
            surname: document.getElementById('editUserSurname').value,
            age: Number(document.getElementById('editUserAge').value),
            email: document.getElementById('editUserEmail').value,
            password: document.getElementById('editUserPassword').value || null,
            roles: selectedRoleIds.map(id => ({ id }))
        };

        const res = await fetch(`/api/admin/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            console.error('Ошибка при обновлении пользователя:', res.status);
        }
    }

    // ------- Удаление пользователя -------

    function openDeleteModal(user) {
        // скрытый id для DELETE
        document.getElementById('deleteUserId').value = user.id;

        // readonly-поля
        document.getElementById('deleteUserIdInput').value = user.id ?? '';
        document.getElementById('deleteUserNameInput').value = user.name ?? '';
        document.getElementById('deleteUserSurnameInput').value = user.surname ?? '';
        document.getElementById('deleteUserAgeInput').value = user.age ?? '';
        document.getElementById('deleteUserEmailInput').value = user.email ?? '';

        // роли в select (disabled)
        const select = document.getElementById('deleteUserRolesSelect');
        select.innerHTML = '';
        (user.roles || []).forEach(role => {
            const opt = document.createElement('option');
            opt.textContent = normalizeRoleName(role.name);
            select.appendChild(opt);
        });

        if (!deleteUserModalInstance) {
            deleteUserModalInstance = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        }
        deleteUserModalInstance.show();
    }

    async function deleteUser() {
        const id = document.getElementById('deleteUserId').value;

        const res = await fetch(`/api/admin/users/${id}`, {
            method: 'DELETE'
        });

        if (!res.ok) {
            console.error('Ошибка при удалении пользователя:', res.status);
        }
    }

    // ------- Инициализация -------

    document.addEventListener('DOMContentLoaded', () => {
        loadCurrentUserInfo();
        loadRoles().then(loadUsers);

        const newUserForm = document.getElementById('newUserForm');
        newUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(newUserForm);
            await createUser(formData);
            await loadUsers();
            newUserForm.reset();

            const usersTab = document.getElementById('users-tab');
            const tabInstance = new bootstrap.Tab(usersTab);
            tabInstance.show();
        });

        const editUserForm = document.getElementById('editUserForm');
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await updateUser();
            if (editUserModalInstance) {
                editUserModalInstance.hide();
            }
            await loadUsers();
        });

        document.getElementById('confirmDeleteUserBtn')
            .addEventListener('click', async () => {
                await deleteUser();
                if (deleteUserModalInstance) {
                    deleteUserModalInstance.hide();
                }
                await loadUsers();
            });
    });
</script>
</body>
</html>